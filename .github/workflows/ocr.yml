name: OCR PDFs to text

on:
  workflow_dispatch:
  schedule:
    - cron: "0 6 * * 1"

permissions:
  contents: write

jobs:
  ocr:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Debug env & LFS
        run: |
          set -e
          echo "=== Git ==="
          git --version
          echo "=== LFS ==="
          git lfs version || true
          git lfs env || true
          echo "=== Tree ==="
          ls -lah
          echo "=== PDFs ==="
          ls -lah pdfs || true
          du -sh pdfs || true

      - name: Pull LFS content
        run: |
          set -e
          git lfs install
          git lfs pull

      - name: Install OCR dependencies
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            ocrmypdf tesseract-ocr tesseract-ocr-eng poppler-utils qpdf ghostscript

      - name: OCR PDFs needing text
        id: ocr
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob
          mkdir -p texts
          MIN_BYTES=800
          changed=0

          need=0
          for f in pdfs/*.pdf; do
            base="${f##*/}"
            stem="${base%.pdf}"
            out="texts/${stem}.txt"
            if [ ! -s "$out" ] || [ "$(wc -c < "$out")" -lt "$MIN_BYTES" ]; then
              need=$((need+1))
            fi
          done
          echo "Needing OCR/text: $need files"

          for f in pdfs/*.pdf; do
            base="${f##*/}"
            stem="${base%.pdf}"
            out="texts/${stem}.txt"

            # Skip if already good enough
            if [ -s "$out" ] && [ "$(wc -c < "$out")" -ge "$MIN_BYTES" ]; then
              continue
            fi

            # Try embedded text first
            if pdftotext -enc UTF-8 "$f" "$out.tmp" && [ "$(wc -c < "$out.tmp")" -ge "$MIN_BYTES" ]; then
              mv "$out.tmp" "$out"
              changed=1
              echo "pdftotext OK: $f"
              continue
            fi
            rm -f "$out.tmp" || true

            # Decide OCR mode: redo if some text, else force
            if pdftotext -enc UTF-8 "$f" - | head -c 1000 | tr -dc '[:alnum:]' | grep -q . ; then
              MODE="--redo-ocr"
            else
              MODE="--force-ocr"
            fi

            # ocrmypdf (fast profile)
            echo "ocrmypdf $MODE: $f"
            ocrmypdf --optimize 0 --oversample 150 -j 2 --tesseract-timeout 900 \
              --sidecar "$out" $MODE "$f" out.pdf || true
            rm -f out.pdf || true

            # Repair + retry if needed
            if [ ! -s "$out" ] || [ "$(wc -c < "$out")" -lt "$MIN_BYTES" ]; then
              echo "Repair & retry: $f"
              qpdf --linearize --decrypt "$f" repaired.pdf || cp "$f" repaired.pdf
              ocrmypdf --optimize 0 --oversample 150 -j 2 --tesseract-timeout 900 \
                --sidecar "$out" $MODE repaired.pdf out.pdf || true
              rm -f repaired.pdf out.pdf || true
            fi

            # Fallback (pdftoppm + tesseract)
            if [ ! -s "$out" ] || [ "$(wc -c < "$out")" -lt "$MIN_BYTES" ]; then
              echo "Fallback tesseract: $f"
              rm -f "$out" || true
              pdftoppm -r 170 -png "$f" p || true
              for p in p-*.png; do tesseract "$p" "$p" --psm 6 -l eng || true; done
              cat p-*.png.txt > "$out" 2>/dev/null || true
              rm -f p-*.png p-*.png.txt || true
            fi

            if [ -s "$out" ] && [ "$(wc -c < "$out")" -ge "$MIN_BYTES" ]; then
              changed=1
              echo "OK: $f -> $out ($(wc -c < "$out") bytes)"
            else
              echo "FAILED: $f"
            fi
          done

          echo "changed=$changed" >> "$GITHUB_OUTPUT"

      - name: Commit & push results
        if: steps.ocr.outputs.changed == '1'
        run: |
          set -e
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add texts/*.txt || true
          git add texts/index_texts.json || true
          git commit -m "Add/update OCR text sidecars (CI)" || echo "Nothing to commit"
          git push
